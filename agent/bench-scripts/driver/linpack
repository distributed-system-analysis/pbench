#!/bin/bash
# -*- mode: shell-script; indent-tabs-mode: t; sh-basic-offset: 8; sh-indentation: 8; tab-width: 8 -*-
#
# "linpack" driver script
#
# Responsible for transforming pbench-linpack command line inputs into the
# the linpack invocation requirements.
#
# The linpack binary expects an input file with 7 lines in it:
#
#     Line 1: Header (disgarded)
#     Line 2: Sub-Header (emitted as-is to stdout)
#     Line 3: Positive integer number of tests to run
#     line 4: Number of equations to solve (problem size)
#     line 5: Leading dimension of array
#     line 6: Number of trials to run
#     line 7: Data alignment value (in Kbytes)
#
# For lines 4-7, if there are N tests to run, each line should have N values
# describing the parameters for those tests. For example:
#
#     Line 1: Header
#     Line 2: Sub-Header
#     Line 3: 3
#     line 4: 10000 20000 30000
#     line 5: 10016 20016 30016
#     line 6:     2     2     2
#     line 7:     4     4     4
#
# This script provides optional input parameters for lines 1, 2, 4 - 7, and
# then calculates the number of tests to be run from those inputs to fill in
# line 3 of the LINPACK input file.
#
# Additionally, it offers input parameters to control the use of OpenMP during
# the LINPACK run, along with the OMP_NUM_THREADS and KMP_AFFINITY environment
# variables used by OpenMP, and if any NUMA controls should be applied (via
# `numactl`).  These parameters are provided in the default "Sub-Header".
#
# The script generates three files:
#
#    ${output_dir}/linpack.input  -  Constructed seven line LINPACK input file
#    ${output_dir}/linpack.meta   -  All input parameters provided as key=val
#    ${output_dir}/linpack.out    -  The output generated by the LINPACK binary
#

script_name="$(basename ${0})"

linpack_input_file_name="linpack.input"
linpack_metadata_file_name="linpack.meta"
linpack_output_file_name="linpack.out"

linpack_binary=""

# Input file defaults, only lines 4-7 (headers defined below).
header=""
subheader=""

# Line 4 default
problem_sizes=20000
# Line 5 default
leading_dimensions=20016
# Line 6 default
run_trials=1
# Line 7 default
alignment_values=4

# Environment input defaults
use_omp="y"
threads_arg=""
kmp_affinity_args="nowarnings,compact,1,0,granularity=fine"
numactl_args=""

# Output directory required.
output_dir=""

function usage() {
	printf -- "TBD -- how to use the pbench linpack driver ...\n"
}

# Process options and arguments
opts=$(getopt -q -o h --longoptions "binary:,header:,subheader:,problem-sizes:,leading-dimensions:,alignment-values:,run-trials:,threads:,use-omp:,kmp-affinity:,numactl-args:,output-dir:,help" -n "getopt.sh" -- "${@}")
if [[ ${?} -ne 0 ]]; then
	printf -- "%s %s\n\n\tunrecognized option specified\n\n" "${script_name}" "${*}" >&2
	usage >&2
	exit 1
fi
eval set -- "${opts}"
while true; do
	arg="${1}"
	shift
	case "${arg}" in
	--binary)
		if [[ -n "${1}" ]]; then
			binary="${1}"
			shift
		fi
		;;
	--header)
		# Values for line 1 of the LINPACK input file
		if [[ -n "${1}" ]]; then
			header="${1}"
			shift
		fi
		;;
	--subheader)
		# Values for line 2 of the LINPACK input file
		if [[ -n "${1}" ]]; then
			subheader="${1}"
			shift
		fi
		;;
	--problem-sizes)
		# Values for line 4 of the LINPACK input file
		if [[ -n "${1}" ]]; then
			problem_sizes=${1//,/ }
			shift
		fi
		;;
	--leading-dimensions)
		# Values for line 5 of the LINPACK input file
		if [[ -n "${1}" ]]; then
			leading_dimensions=${1//,/ }
			shift
		fi
		;;
	--run-trials)
		# Values for line 6 of the LINPACK input file
		if [[ -n "${1}" ]]; then
			run_trials=${1//,/ }
			shift
		fi
		;;
	--alignment-values)
		# Values for line 7 of the LINPACK input file
		if [[ -n "${1}" ]]; then
			alignment_values=${1//,/ }
			shift
		fi
		;;
	--threads)
		if [[ -n "${1}" ]]; then
			threads_arg="${1}"
			shift
		fi
		;;
	--use-omp)
		if [[ -n "${1}" ]]; then
			use_omp="${1}"
			shift
		fi
		;;
	--kmp-affinity)
		if [[ -n "${1}" ]]; then
			kmp_affinity_args="${1}"
			shift
		fi
		;;
	--numactl-args)
		if [[ -n "${1}" ]]; then
			numactl_args="${1}"
			shift
		fi
		;;
	--output-dir)
		if [[ -n "${1}" ]]; then
			output_dir="${1}"
			shift
		fi
		;;
	-h|--help)
		usage
		exit 0
		;;
	--)
		break
		;;
	*)
		printf -- "[%s] WARNING: unrecognized parameter encountred, '%s'\n" "${script_name}" "${arg}" >&2
		break
		;;
	esac
done

if [[ -z "${output_dir}" || ! -d "${output_dir}" ]]; then
	printf -- "[%s] ERROR: Specified --output-dir '${output_dir}' is not a directory\n" "${script_name}" >&2
	exit 2
fi
if [[ -z "${binary}" ]]; then
	printf -- "[%s] ERROR: You must specify --binary\n" "${script_name}" >&2
	exit 3
fi
if [[ ! -e "${binary}" || ! -x "${binary}" ]]; then
	printf -- "[%s] ERROR: The --binary must exist and be executable\n" "${script_name}" >&2
	exit 4
fi
if [[ "${use_omp}" != "y" && "${use_omp}" != "n" ]]; then
	printf -- "[%s] ERROR: --use-omp must either by 'y' or 'n'\n" "${script_name}" >&2
	exit 5
fi
num_problem_sizes=$(echo "${problem_sizes}" | wc -w)
num_leading_dimensions=$(echo "${leading_dimensions}" | wc -w)
num_run_trials=$(echo "${run_trials}" | wc -w)
num_alignment_values=$(echo "${alignment_values}" | wc -w)
if [[ "${num_problem_sizes}" != "${num_leading_dimensions}" || "${num_leading_dimensions}" != "${num_run_trials}" || "${num_run_trials}" != "${num_alignment_values}" ]]; then
	printf -- "[%s] ERROR: You must have the same number of elements for --problem-sizes, --leading-dimensions, --run-trials, and --alignment-values\n" >&2
	exit 6
fi
number_of_tests=${num_problem_sizes}

linpack_input_file="${output_dir}/${linpack_input_file_name}"
linpack_metadata_file="${output_dir}/${linpack_metadata_file_name}"
linpack_output_file="${output_dir}/${linpack_output_file_name}"

numactl_cmd=""
if [[ -n "${numactl_args}" ]]; then
	# N.B. - Trailing whitespace is required.
	numactl_cmd="numactl ${numactl_args} "
fi

if [[ "${use_omp}" == "y" ]]; then
	if [[ -z "${threads_arg}" ]]; then
		threads_arg=$(cat /proc/cpuinfo | grep processor | wc -l)
	fi
	# N.B. - Trailing whitespace is required.
	omp_num_threads="OMP_NUM_THREADS=${threads_arg} "
	# N.B. - Trailing whitespace is required.
	kmp_affinity="KMP_AFFINITY=${kmp_affinity_args} "
else
	# When "use OpenMP" is false, we are not going to use the "threads_arg" or "kmp_affinity_args"
	threads_arg=""
	kmp_affinity_args=""

	# No environment variables to add to the command line.
	omp_num_threads=""
	kmp_affinity=""
fi
final_cmd="${omp_num_threads}${kmp_affinity}${numactl_cmd}${binary} ${linpack_input_file} | stdbuf --input=0 tee -i ${linpack_output_file}"

if [[ -z "${header}" ]]; then
	# Line 1 default
	header="Pbench - LINPACK Benchmark data file (${linpack_input_file})"
fi
if [[ -z "${subheader}" ]]; then
	# Line 2 default header
	subheader="Pbench LINPACK Benchmark data -- ${final_cmd}"
fi

# Create the LINPACK input file.
printf -- "%s\n%s\n%d # number of tests\n%s # problem sizes\n%s # leading dimensions\n%s # times to run a test\n%s # alingment values (in KBytes)\n" \
	"${header}" \
	"${subheader}" \
	"${number_of_tests}" \
	"${problem_sizes}" \
	"${leading_dimensions}" \
	"${run_trials}" \
	"${alignment_values}" \
	> ${linpack_input_file}

# Now we can execute the final LINPACK command.
eval ${final_cmd}
exit_code=${?}

# Create the linpack.meta file containing all the metadata used for invoking
# LINPACK (does not include "header" or "subheader").  This serves as the marker
# file for its completion.
printf -- "binary=%s\nuse_omp=%s\nthreads=%s\nkmp_affinity=%s\nnumactl_cmd=%s\nproblem_sizes=%s\nleading_dimensions=%s\nalignment_values=%s\n" \
	"${binary}" \
	"${use_omp}" \
	"${threads_arg}" \
	"${kmp_affinity_args}" \
	"${numactl_cmd}" \
	"${problem_sizes}" \
	"${leading_dimensions}" \
	"${alignment_values}" \
	> ${linpack_metadata_file}

exit ${exit_code}
