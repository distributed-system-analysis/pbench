#!/usr/bin/env python

import sys, json, os, logging

benchmark_run_dir = sys.argv[1]
benchmark_duration = int(sys.argv[2])

with open('%s/user-benchmark-summary.json' % benchmark_run_dir, 'a+') as data_file:
    try:
        data = json.load(data_file)
    except ValueError:
        data = {}
    if "duration" in data:
        # JSON file has a duration field, so we don't have to do anything.
        pass
    else:
        # At this point we may or may not have a dictionary of data loaded from
        # the JSON file, but we do know that if we did load some JSON it did not
        # have a duration field in it.
        data['duration'] = benchmark_duration
        data['duration_units'] = "sec"
    if data_file.tell() == 0:
        # Either there was nothing in the file, or they didn't create the file.
        logging.warn("benchmark run didn't create a %s/user-benchmark-summary.json or the file is empty", benchmark_run_dir)
    # Prepare to re-write the file with an updated JSON document.
    data_file.seek(0, os.SEEK_SET)
    data_file.truncate(0)
    json.dump(data, data_file, sort_keys=True, indent=4, separators=(',', ':'))
