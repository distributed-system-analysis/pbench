#!/bin/bash -e

echo "Starting PostgreSQL container" >&2
jenkins/podman run --name postgresql-alembic \
    --detach \
    --rm \
    --network host \
    --workdir /opt/app-root/src \
    --env 'PATH=/opt/app-root/src/bin:/opt/app-root/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin' \
    --env 'TERM=xterm' \
    --env 'container=oci' \
    --env 'STI_SCRIPTS_URL=image:///usr/libexec/s2i' \
    --env 'PGUSER=postgres' \
    --env 'PLATFORM=el8' \
    --env 'APP_DATA=/opt/app-root' \
    --env 'CONTAINER_SCRIPTS_PATH=/usr/share/container-scripts/postgresql' \
    --env 'ENABLED_COLLECTIONS' \
    --env 'POSTGRESQL_VERSION=13' \
    --env 'APP_ROOT=/opt/app-root' \
    --env 'STI_SCRIPTS_PATH=/usr/libexec/s2i' \
    --env 'HOME=/var/lib/pgsql' \
    --env 'POSTGRESQL_USER=pbench' \
    --env 'POSTGRESQL_PASSWORD=pbench' \
    --env 'POSTGRESQL_DATABASE=pbench' \
    images.paas.redhat.com/pbench/postgresql-13:latest container-entrypoint run-postgresql

trap "echo 'Stopping PostgreSQL container' >&2 ; jenkins/podman stop postgresql-alembic" INT ABRT QUIT EXIT

# If the timeout is reached, the `timeout` command will exit with an error (124)
# which will cause the script to exit immediately and trigger the `trap` above.
timeout 60s bash -c 'until nc -z localhost 5432; do
    echo "Waiting for PostgreSQL" >&2
    sleep 1
done'

echo "Starting tox" >&2
EXTRA_PODMAN_SWITCHES="${EXTRA_PODMAN_SWITCHES} --network host" jenkins/run tox -e alembic-check
